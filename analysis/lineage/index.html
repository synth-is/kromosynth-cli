<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta
        http-equiv="Referrer-Policy"
        content="no-referrer" />
    <title>Phylogenetic Tree Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>
    <div id="controls">
        Run: <select id="runSelect"></select>
        Category: <select id="categorySelect"></select>
        Step: <select id="stepSelect"></select>
        <!-- Max Depth: <input type="number" id="maxDepth" value="Infinity"> -->
        Measure Context Switches: <input type="checkbox" id="measureContextSwitches">
        Suffix Filter: <input type="text" id="suffixFilter">
    </div>
    <div id="visualization-container"></div>

    <script type="module">
        import { createInteractiveVisualization } from './phylogenetic-tree-interactive.js';

        const lineageTrees = {
            "classScorVarAsContainerDims_noOsc": {
                "all": [
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36C4N993C11EY54VJ1DWXTJ_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJ9VWKHFBHDBKMF33V8D7_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJ9W2R5MHRG4PWPZHCBE4_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJK0BJ85G1HY3JSCHV8HW_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJK15ZB1HY720Z0075VZA_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json"
                ],
                "musical": [
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36C4N993C11EY54VJ1DWXTJ_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJ9VWKHFBHDBKMF33V8D7_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJ9W2R5MHRG4PWPZHCBE4_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJK0BJ85G1HY3JSCHV8HW_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJK15ZB1HY720Z0075VZA_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json"
                ],
                "non-musical": [
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36C4N993C11EY54VJ1DWXTJ_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJ9VWKHFBHDBKMF33V8D7_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJ9W2R5MHRG4PWPZHCBE4_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJK0BJ85G1HY3JSCHV8HW_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc/tree_01J36CJK15ZB1HY720Z0075VZA_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json"
                ]
            },
            "classScorVarAsContainerDims_noOsc_oneCPPNPerFreq": {
                "all": [
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KTWF8ZAE6B5S2XN51YRQEK_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KV837NZFC47ZZ4FVQT668K_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KV8384NYH1WQBQ8WNPTPYJ_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KWK0FTWDQPSNXT0HBEX48Y_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KWPN20HA1A4PS9FNY7XR17_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_all.json",
                ],
                "musical": [
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KTWF8ZAE6B5S2XN51YRQEK_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KV837NZFC47ZZ4FVQT668K_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KV8384NYH1WQBQ8WNPTPYJ_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KWK0FTWDQPSNXT0HBEX48Y_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KWPN20HA1A4PS9FNY7XR17_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_musical.json",
                ],
                "non-musical": [
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KTWF8ZAE6B5S2XN51YRQEK_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KV837NZFC47ZZ4FVQT668K_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KV8384NYH1WQBQ8WNPTPYJ_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KWK0FTWDQPSNXT0HBEX48Y_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                    "lineageTrees/classScorVarAsContainerDims_noOsc_oneCPPNPerFreq/tree_01J4KWPN20HA1A4PS9FNY7XR17_classScoringVariationsAsContainerDimensions_noOsc_5dur-1ndelt-1vel_nonmusical.json",
                ]
            },
            // "Run 2": {
            //     "all": [
            //         "evolution-run-analysis_lineage_step-1_1723727836945.json",
            //         "evolution-run-analysis_lineage_step-2_1723727836945.json",
            //         "evolution-run-analysis_lineage_step-3_1723727836945.json",
            //     ],
            //     "musical": [
            //         "evolution-run-analysis_lineage_step-1_1723727836945.json",
            //         "evolution-run-analysis_lineage_step-2_1723727836945.json",
            //         "evolution-run-analysis_lineage_step-3_1723727836945.json",
            //     ],
            //     "non-musical": [
            //         "evolution-run-analysis_lineage_step-1_1723727836945.json",
            //         "evolution-run-analysis_lineage_step-2_1723727836945.json",
            //         "evolution-run-analysis_lineage_step-3_1723727836945.json"
            //     ]
            // }
        };

        function populateSelect(selectId, options, defaultValue = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = ''; // Clear existing options
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                if (option === defaultValue) {
                    optionElement.selected = true;
                }
                select.appendChild(optionElement);
            });
        }

        function updateCategorySelect() {
            const selectedRun = document.getElementById('runSelect').value;
            const categories = Object.keys(lineageTrees[selectedRun]);
            populateSelect('categorySelect', categories, 'musical');
            updateStepSelect();
        }

        function updateStepSelect() {
            const selectedRun = document.getElementById('runSelect').value;
            const selectedCategory = document.getElementById('categorySelect').value;
            const steps = lineageTrees[selectedRun][selectedCategory];
            populateSelect('stepSelect', steps.map((_, index) => `Step ${index + 1}`));
            loadData();
        }

        async function loadData() {
            const selectedRun = document.getElementById('runSelect').value;
            const selectedCategory = document.getElementById('categorySelect').value;
            const selectedStepIndex = document.getElementById('stepSelect').selectedIndex;
            const selectedStep = lineageTrees[selectedRun][selectedCategory][selectedStepIndex];

            // set evoRunId as a substring from selectedStep, between "lineageTrees/tree_" and ("_all.json" or "_musical.json" or "_nonmusical.json")
            let suffixIndex;
            if (selectedStep.includes("_all.json")) {
                suffixIndex = selectedStep.indexOf("_all.json");
            } else if (selectedStep.includes("_musical.json")) {
                suffixIndex = selectedStep.indexOf("_musical.json");
            } else if (selectedStep.includes("_nonmusical.json")) {
                suffixIndex = selectedStep.indexOf("_nonmusical.json");
            }
            const experiment = selectedRun;
            const evoRunId = selectedStep.substring(selectedStep.indexOf("tree_")+5, suffixIndex);
            console.log("evoRunId", evoRunId);
            console.log("experiment", experiment);

            try {
                const response = await fetch(selectedStep);
                const data = await response.json();

                const container = document.getElementById('visualization-container');
                container.innerHTML = ''; // Clear existing visualization

                createInteractiveVisualization(undefined/*lineageData*/, data, experiment, evoRunId, container, {
                    // maxDepth: parseInt(document.getElementById('maxDepth').value) || Infinity,
                    measureContextSwitches: document.getElementById('measureContextSwitches').checked,
                    suffixFilter: document.getElementById('suffixFilter').value || null
                });
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('visualization-container').innerHTML = 'Error loading data. Please check the console for details.';
            }
        }

        // Event listeners
        document.getElementById('runSelect').addEventListener('change', updateCategorySelect);
        document.getElementById('categorySelect').addEventListener('change', updateStepSelect);
        document.getElementById('stepSelect').addEventListener('change', loadData);
        // document.getElementById('maxDepth').addEventListener('input', loadData);
        document.getElementById('measureContextSwitches').addEventListener('change', loadData);
        document.getElementById('suffixFilter').addEventListener('input', loadData);

        // Initial setup
        populateSelect('runSelect', Object.keys(lineageTrees));
        updateCategorySelect();
    </script>
</body>
</html>